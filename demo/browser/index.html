<!DOCTYPE html>
<html>
<head>
    <title>DEJE WAMP demo</title>
    <style>

.log-container {
    background-color: #CCC;
    border: 2px solid black;
    width: 100%;
    min-height: 200px;
    border-radius: 10px;
}

pre {
    margin: 10px;
}

.submitter {
    width: 100%;
    margin-top: 1em;
}

#message-input {
    width: 100%;
    min-height: 5em;
}

.events {
    width: 80%;
    padding-left: 10px;
    padding-bottom: 10px;
    background-color: #DDD;
}

.event {
    margin: 15px 10px;
    background-color: white;
}

.event .hash {
    padding: 10px;
    background-color: #2B2;
    width: 100%;
}

.event .hash button {
    float: right;
}

.event .content {
    width: 100%;
    padding: 5px;
}

.event input {
    width: 400px;
}

.event textarea {
    width: 600px;
    min-height: 100px;
}

    </style>
    <script src="/autobahn.js"></script>
    <script src="/jsSHA-1.5.0/src/sha1.js"></script>
    <script src="/js-deje/deje.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
</head>

<body>
    <h1>DEJE WAMP demo</h1>
    <p>Start up a few clients, and then watch the logging output ensue!</p>

    <h3>Callbacks</h3>
    <div class="callbacks-selection">
    </div>

    <h3>Reconnect</h3>
    <div class="reconnector">
        <input class="url"   type="text" placeholder="">
        <input class="topic" type="text" placeholder="">
        <button type="submit">Reconnect</button>
    </div>

    <h3>
        Log
        <button onclick="log_clear()" style="float:right">Clear log</button>
    </h3>
    <div class="log-container">
        <pre id="log"></pre>
    </div>

    <h3>State</h3>
    <pre id="state-data"></pre>
    <div class="submitter">
        <textarea id="message-input" placeholder="JSON data to broadcast"></textarea>
        <br/><button id="message-submit">Broadcast a message</button>
    </div>

    <h3>Events</h3>
    <div class="events">
        <div class="event input">
            <div class="hash">Create new event <button onclick="save_event()">Finish</button></div>
            <input class="parent" placeholder="Parent Hash"/><br/>
            <input class="handler" placeholder="Handler Name"/><br/>
            <textarea class="args" placeholder="Args (start with {})"></textarea>
        </div>
    </div>

    <script>
URL   = "ws://" + window.location.host + "/ws";
TOPIC = "deje://demo/";

$('.reconnector .url').attr(  'placeholder', URL);
$('.reconnector .topic').attr('placeholder', TOPIC);

function loggit(info) {
    $('#log').text( $('#log').text() + info + "\n" );
}

function log_clear() {
    $('#log').text('');
}

$('.reconnector button').click(function() {
    reconnect(
        $('.reconnector .url').val(),
        $('.reconnector .topic').val()
    );
});

function get_msg_input() {
    var data = $('#message-input').val();
    try {
        return JSON.parse(data);
    } catch (e) {
        return loggit("<your browser>: Message is not valid JSON")
    }
}

$('#message-submit').click(function(){
    var data = get_msg_input()
    if (data != undefined) {
        client.publish(data);
    }
});

function render_state() {
    $('#state-data').text(
        "hash: '" + client.state.hash + "'\n\n"
        + JSON.stringify(client.state.content, null, 4)
    );
}

function render_callbacks() {
    var root = $('.callbacks-selection');
    root.empty();
    var on_change = function() {
        var callback = $(this).data("callback");
        callback.enabled = $(this).is(":checked");
    };
    for (var m in client.cb_managers) {
        var manager = client.cb_managers[m];
        for (var c in manager.callbacks) {
            var callback = manager.callbacks[c];
            var checkbox = $(document.createElement('input'))
                .attr('type', 'checkbox')
                .attr('checked', callback.enabled)
                .data('callback', callback)
                .change(on_change);
            var label = $(document.createElement('label'))
                .append(checkbox)
                .append("on_" + m + " :: " + c);
            root.append(label);
            root.append("<br>");
        }
    }
}

function render_event(ev) {
    var ev_hash = ev.getHash();
    var ev_content = ev.getContent();

    var element = $(document.createElement('div'))
        .addClass('event')
        .data('hash', ev_hash);
    var promote_button = $(document.createElement('button'))
        .text("Promote")
        .click(promote_event_by_element);
    var goto_button = $(document.createElement('button'))
        .text("Goto")
        .click(goto_event_by_element);
    var hash_bar = $(document.createElement('div'))
        .addClass('hash')
        .text(ev_hash)
        .append(promote_button)
        .append(goto_button);
    var content = $(document.createElement('pre'))
        .addClass('content')
        .text( JSON.stringify(ev_content, null, 4) );

    element.append(hash_bar);
    element.append(content);
    return element;
}

function render_events() {
    $(".event").not(".input").remove();
    var history = client.getHistory();
    for (var i = 0; i<history.length; i++) {
        var ev = history[i];
        $(".events").prepend(render_event(ev));
    }
}

function promote_event_by_hash(hash) {
    ev = client.getEvent(hash);
    if (ev != undefined) {
        client.promoteEvent(ev);
    } else {
        loggit("<your browser>: No such hash: " + hash);
    }
    return false;
}

function promote_event_by_element() {
    hash = $(this).closest('.event').data('hash');
    return promote_event_by_hash(hash);
}

function goto_event_by_element() {
    hash = $(this).closest('.event').data('hash');

    ev = client.getEvent(hash);
    if (ev != undefined) {
        client.applyEvent(ev);
        render_state();
    } else {
        loggit("<your browser>: No such hash: " + hash);
    }
    return false;
}

function save_event() {
    var content = {
        "parent": $('.event.input .parent').val() || "",
        "handler": $('.event.input .handler').val() || "",
    };
    try {
        content.args = JSON.parse($('.event.input .args').val());
    } catch (e) {
        return loggit("<your browser>: Invalid JSON for event args")
    }
    client.storeEvent(new DejeEvent(content));
}

function reconnect(url, topic) {
    if (window.client && window.client.session) {
        window.client.session.close()
    }
    window.client = new DejeClient(url || URL, topic || TOPIC, { 'logger': loggit });
    window.client.connect();


    window.client.cb_managers.store_event.add('render_events', render_events);
    window.client.cb_managers.goto_event.add('render_state', render_state);

    render_events();
    render_state();
    render_callbacks();
}

reconnect();
    </script>
</body>
</html>
