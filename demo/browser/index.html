<!DOCTYPE html>
<html>
<head>
    <title>DEJE WAMP demo</title>
    <style>

.log-container {
    background-color: #CCC;
    border: 2px solid black;
    width: 100%;
    min-height: 200px;
    border-radius: 10px;
}

pre {
    margin: 10px;
}

.submitter {
    width: 100%;
    margin-top: 1em;
}

#message-input {
    width: 100%;
    min-height: 5em;
}

    </style>
    <script src="/autobahn.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
</head>

<body>
    <h1>DEJE WAMP demo</h1>
    <p>Start up a few clients, and then watch the logging output ensue!</p>
    <h3>Log</h3>
    <div class="log-container">
        <pre id="log"></pre>
    </div>
    <div class="submitter">
        <textarea id="message-input" placeholder="JSON data to broadcast"></textarea>
        <br/><button id="message-submit">Broadcast a message</button>
    </div>
    <script>

URL   = "ws://localhost:8080/ws";
TOPIC = "http://demo/";

window.session = undefined;

function loggit(info) {
    $('#log').text( $('#log').text() + info + "\n" );
}

function on_msg(topic, msg) {
    loggit(topic + ": " + JSON.stringify(msg))
}

ab.connect(
    URL,
    function (session) {
        loggit("<your browser>: Connected to router")
        window.session = session;

        session.subscribe(TOPIC, on_msg);
    },
    function (code, reason, detail) {
        loggit("<your browser>: Disconnected from router")
        loggit("Err code " + code + ": " + reason)
        loggit(JSON.stringify(detail))
        window.session = undefined;
    }
);

function get_msg_input() {
    var data = $('#message-input').val();
    try {
        return JSON.parse(data);
    } catch (e) {
        return loggit("<your browser>: Message is not valid JSON")
    }
}

$('#message-submit').click(function(){
    var data = get_msg_input()
    if (data != undefined) {
        session.publish(TOPIC, data);
    }
});

    </script>
</body>
</html>
